---
title: "The Effects of Climate Change on the Breeding Success and Timing of African White-backed Vultures"
author: "Mieke Deyzel"
output: html_document
format:
  html:
    embed-resources: true
---
::: {.panel-tabset}
  
## Packages   
 
```{r}
#remotes::install_github("ropensci/rnoaa")
#remotes::install_github("ropensci/chirps")
#install.packages("GSODR")
#install.packages("AICcmodavg")

```

### Load Libraries
```{r}

library(tidyverse)
library(lubridate)
library(janitor)
library(MASS)
library(patchwork)
library(stringr)
library(tibble) 
library(dplyr)
library(knitr)
library(ggplot2)
library(GGally)
library(tidyr)
library(chirps)
library(GSODR)
library(tibble)
library(knitr)
library(AICcmodavg)
library(lme4)


```

### Overdispersion Check 

```{r}
check_overdispersion <- function(model) {
  rp <- residuals(model, type = "pearson")
  disp <- sum(rp^2) / model$df.residual
  disp
} 
```


## Load Data

```{r}
vultures    <- read.csv("~/Desktop/Vulture Project/Data/93_24 cleaned.csv")
# WeatherData <- read.csv("~/Desktop/Vulture Project/Data/Weather.csv")
```

### Weather Data 

```{r}
library(rnoaa)
library(tidyverse)
library(lubridate)

 
kim_station <- "684380-99999"

weather_raw <- get_GSOD(
  station = kim_station,
  years   = 1993:2024
)



```

```{r}
WeatherData <- weather_raw |>
  transmute(
    YEAR,
    MONTH,
    DAY,
    TEMP,
    MAX,
    MIN,
    PRCP,
    WDSP,
    MXSPD,
    I_HAIL
  ) |>
  arrange(YEAR, MONTH, DAY)

```

### CHIRPS Rainfall for 2004 

```{r}
# coordinates  (24.81 E, 28.62 S)

lonlat <- data.frame(
lon = 24.81,
lat = -28.62
)

kimberley_chirps_2004 <- get_chirps(
object   = lonlat,
dates    = c("2004-01-01", "2004-12-31"),
server   = "ClimateSERV",
as.matrix = FALSE
)

glimpse(kimberley_chirps_2004)

```

### CHIRPS Rainfall for 2004 (Dronfield / Kimberley)

```{r}
daily_chirps_2004 <- tibble(
date    = as.Date(kimberley_chirps_2004$date),
rain_mm = as.numeric(kimberley_chirps_2004$chirps)
)

head(daily_chirps_2004) 
summary(daily_chirps_2004$rain_mm)

annual_chirps_2004 <- daily_chirps_2004 |>
mutate(YEAR = year(date)) |>
group_by(YEAR) |>
summarise(
total_rain_2004 = sum(rain_mm, na.rm = TRUE),
max_rain_2004   = max(rain_mm, na.rm = TRUE),
rain_days_2004  = sum(rain_mm > 0, na.rm = TRUE),
.groups = "drop"
)

annual_chirps_2004

```


```{r}
total_rain_2004 <- annual_chirps_2004$total_rain_2004
max_rain_2004   <- annual_chirps_2004$max_rain_2004
rain_days_2004  <- annual_chirps_2004$rain_days_2004

total_rain_2004
max_rain_2004
rain_days_2004

```
### Weather Data 

```{r}
WeatherData_clean <- WeatherData |>
  filter(
    YEAR >= 1993,
    YEAR <= 2024
  ) |>
  mutate(
    date = make_date(YEAR, MONTH, DAY)
  ) |>
  # add CHIRPS daily rainfall into 2004 
  left_join(daily_chirps_2004, by = "date") |>
  mutate(
    PRCP = if_else(YEAR == 2004 & !is.na(rain_mm), rain_mm, PRCP)
  ) |>
  dplyr::select(-rain_mm) 


```

## Clean breeding data 

```{r}
vultures.clean <- vultures |>
  clean_names() |>                               # ringing_date, laying_date
  rename_with(~ gsub("_", ".", .x)) |>           # ringing.date, laying.dater
  mutate(
    ringing.date = ringing.date |> as.character() |> str_trim(),
    ringing.date = if_else(ringing.date %in% c("", "NA", "?"),
                           NA_character_, ringing.date),
    ringing.date = ymd(gsub("/", "-", ringing.date)),
    
    laying.date  = laying.date |> as.character() |> str_trim(),
    laying.date  = if_else(laying.date %in% c("", "NA", "?"),
                           NA_character_, laying.date),
    laying.date  = ymd(gsub("/", "-", laying.date))
  )
```

## Explore Data 

```{r}
glimpse(vultures.clean)
summary(vultures.clean)
colSums(is.na(vultures.clean))

```

### Active Nests per year 

```{r}
active.nests.raw <- vultures.clean |>
mutate(year = year(ringing.date)) |>
group_by(year) |>
summarise(active_nests = n(), .groups = "drop")

ggplot(active.nests.raw, aes(x = year, y = active_nests)) +
geom_col(fill = "#89c5d6", alpha = 0.85) +
labs(x = "Year", y = "Number of active nests") +
theme_bw() +
theme(panel.grid = element_blank())

```

### Success proportion

```{r}
failed.nests.raw <- vultures.clean |>
mutate(year = year(ringing.date)) |>
group_by(year) |>
summarise(
active_nests  = n(),
success_nests = sum(!is.na(laying.date)),
success_prop  = success_nests / active_nests,
.groups       = "drop"
)

ggplot(failed.nests.raw, aes(x = success_prop)) +
geom_histogram(bins = 15, fill = "#89c5d6") +
labs(x = "Breeding success proportion", y = "Count") +
theme_bw() +
theme(panel.grid = element_blank())

```


### Annual Weather Summaries 

```{r}
weather_yearly <- WeatherData_clean |>
group_by(YEAR) |>
summarise(
mean_temp  = mean(TEMP, na.rm = TRUE),
max_temp   = max(MAX, na.rm = TRUE),
min_temp   = min(MIN, na.rm = TRUE),
total_rain = sum(PRCP, na.rm = TRUE),
max_rain   = max(PRCP, na.rm = TRUE),
rain_days  = sum(PRCP > 0, na.rm = TRUE),
mean_wind  = mean(WDSP, na.rm = TRUE),
max_wind   = max(MXSPD, na.rm = TRUE),
hail_days  = sum(I_HAIL, na.rm = TRUE),
.groups    = "drop"
)

# Check the corrected 2004 rainfall

weather_yearly[weather_yearly$YEAR == 2004,
c("YEAR", "total_rain", "max_rain", "rain_days")]

```

### Plot Annual Rainfall

```{r}
ggplot(weather_yearly, aes(x = YEAR, y = total_rain)) +
geom_line() +
geom_point() +
theme_bw() +
labs(x = "Year", y = "Total annual rainfall (mm)")

```

### Rain over time 

```{r}
library(grid) 

rain_yearly <- weather_yearly

rain_long <- rain_yearly |>
pivot_longer(
cols = c(total_rain, max_rain, rain_days),
names_to = "metric",
values_to = "value"
) |>
mutate(
metric = factor(
metric,
levels = c("total_rain", "max_rain", "rain_days")
),
metric_label = case_when(
metric == "total_rain" ~ "Total annual rainfall (mm)",
metric == "max_rain"   ~ "Max daily rainfall (mm)",
metric == "rain_days"  ~ "Number of rainy days (> 0 mm)"
),
metric_label = factor(
metric_label,
levels = c(
"Total annual rainfall (mm)",
"Max daily rainfall (mm)",
"Number of rainy days (> 0 mm)"
)
)
)

ggplot(rain_long, aes(x = YEAR, y = value)) +
geom_line(linewidth = 0.7) +
geom_point(size = 1.3) +
facet_wrap(~ metric_label, ncol = 1, scales = "free_y") +
theme_classic() +
labs(
x = "Year",
y = NULL
) +
theme(
strip.text    = element_text(size = 9, face = "bold"),
axis.title.x  = element_text(size = 10),
axis.text     = element_text(size = 8),
panel.spacing = unit(0.7, "lines")
)

```

### Check min temp 

```{r}
# Yearly 

ggplot(weather_yearly, aes(x = YEAR, y = min_temp)) +
geom_line() +
geom_point() +
theme_bw() +
labs(x = "Year", y = "Annual minimum temperature (°C)")

```

```{r}
# Daily 

weather_daily <- WeatherData_clean |>
group_by(YEAR, MONTH, DAY) |>
summarise(
mean_temp  = mean(TEMP, na.rm = TRUE),
max_temp   = max(MAX,  na.rm = TRUE),
min_temp   = min(MIN,  na.rm = TRUE),
total_rain = sum(PRCP, na.rm = TRUE),
max_rain   = max(PRCP, na.rm = TRUE),
rain_days  = sum(PRCP > 0, na.rm = TRUE),
mean_wind  = mean(WDSP, na.rm = TRUE),
max_wind   = max(MXSPD, na.rm = TRUE),
hail_days  = sum(I_HAIL, na.rm = TRUE),
.groups    = "drop"
)

temp_daily <- weather_daily |>
mutate(
min_temp = ifelse(is.infinite(min_temp), NA_real_, min_temp),
max_temp = ifelse(is.infinite(max_temp), NA_real_, max_temp)
)

summary(temp_daily$min_temp)
summary(temp_daily$max_temp)


```

### Yearly temp summaries 

```{r}
weather_yearly_temp <- weather_daily |>
filter(YEAR >= 1993, YEAR <= 2024) |>
group_by(YEAR) |>
summarise(
mean_temp = mean(mean_temp, na.rm = TRUE),
max_temp  = max(max_temp, na.rm = TRUE),
min_temp  = min(min_temp, na.rm = TRUE),
.groups   = "drop"
)

summary(weather_yearly_temp$min_temp)
summary(weather_yearly_temp$max_temp)

```

### Temps over time 

```{r}
min_temp <- ggplot(weather_yearly_temp, aes(YEAR, min_temp)) +
geom_line() +
geom_point() +
theme_bw() +
labs(x = "Year", y = "Annual minimum temperature (°C)")

max_temp <- ggplot(weather_yearly_temp, aes(x = YEAR, y = max_temp)) +
geom_line() +
geom_point() +
theme_bw() +
labs(
x = "Year",
y = "Annual maximum temperature (°C)",
title = "Annual Maximum Temperature (1993–2024)"
)

mean_temp <- ggplot(weather_yearly_temp, aes(x = YEAR, y = mean_temp)) +
geom_line() +
geom_point() +
theme_bw() +
labs(
x = "Year",
y = "Annual mean temperature (°C)",
title = "Annual Mean Temperature (1993–2024)"
)

```

```{r}
temp_yearly_long <- weather_yearly_temp |>
pivot_longer(
cols = c(max_temp, min_temp, mean_temp),
names_to = "type",
values_to = "value"
) |>
mutate(
type = factor(
type,
levels = c("max_temp", "min_temp", "mean_temp"),
labels = c("Annual Maximum Temperature (°C)",
"Annual Minimum Temperature (°C)",
"Annual Mean Temperature (°C)")
)
)

ggplot(temp_yearly_long, aes(x = YEAR, y = value)) +
geom_line(size = 0.7) +
geom_point(size = 1.5) +
facet_wrap(~ type, scales = "free_y", ncol = 1) +
theme_classic(base_size = 11) +
theme(
strip.text   = element_text(size = 10, face = "bold"),
axis.title   = element_text(size = 9),
axis.text    = element_text(size = 8),
panel.spacing = unit(0.8, "lines")
) +
labs(
x = "Year",
y = "",
title = "Annual Temperature Trends (1993–2024)"
)

```

### Lagged Weather summaries 

```{r}
weather_yearly_lag <- weather_yearly |>
arrange(YEAR) |>
mutate(
across(
c(mean_temp, max_temp, min_temp, total_rain, max_rain,
rain_days, mean_wind, max_wind, hail_days),
~ lag(.x, 1), .names = "lag_{.col}"
)
)

```

### Daily weather with lagged variables 
```{r}
weather_lag <- WeatherData_clean |>
mutate(
mean_temp = readr::parse_number(as.character(TEMP)),
max_temp  = readr::parse_number(as.character(MAX)),
min_temp  = readr::parse_number(as.character(MIN)),
mean_wind = readr::parse_number(as.character(WDSP)),
max_wind  = readr::parse_number(as.character(MXSPD)),
rain      = readr::parse_number(as.character(PRCP)),
rain_day  = as.integer(replace_na(rain, 0) > 0),
hail      = I_HAIL
) |>
arrange(date)
 
```

### Check for weather correlation 

```{r}
weather_yearly |>
  dplyr::select(
    mean_temp, max_temp, min_temp,
    total_rain, max_rain, rain_days,
    mean_wind, max_wind, hail_days
  )


```

```{r}
cor_mat <- weather_yearly |>
dplyr::select(mean_temp, max_temp, min_temp, total_rain, max_rain,
rain_days, mean_wind, max_wind, hail_days) |>
cor(use = "pairwise.complete.obs")

cor_df <- as.data.frame(cor_mat) |>
rownames_to_column("var1") |>
pivot_longer(-var1, names_to = "var2", values_to = "cor")

ggplot(cor_df, aes(x = var1, y = var2, fill = cor)) +
geom_tile() +
scale_fill_gradient2(
low = "#b2182b", mid = "white", high = "#2166ac",
midpoint = 0, limits = c(-1, 1)
) +
labs(x = "", y = "", fill = "Correlation") +
theme_bw() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
panel.grid  = element_blank()
)

```
 
### All weather across years

```{r}
weather_yearly |>
pivot_longer(-YEAR) |>
ggplot(aes(x = YEAR, y = value)) +
geom_line(colour = "#89c5d6") +
facet_wrap(~ name, scales = "free_y") +
labs(x = "Year", y = "Value") +
theme_bw() +
theme(panel.grid = element_blank())

```



## Objective 1

```{r}
# Effort Data 

active.nests <- vultures.clean |>
mutate(year = year(ringing.date)) |>
group_by(year) |>
summarise(active_nests = n(), .groups = "drop")

effort_weather <- active.nests |>
left_join(weather_yearly, by = c("year" = "YEAR"))

```


### Year only model 

```{r}
m_year <- glm.nb(active_nests ~ year, data = active.nests)
summary(m_year)
check_overdispersion(m_year)

```

### Autocorrelation in residuals

```{r}
res_effort <- residuals(m_year, type = "pearson")

acf(res_effort,
main = "ACF of residuals: breeding effort (active nests)")

```


### Rainfall 

```{r}
effort_weather <- effort_weather |>
mutate(
z_total_rain = scale(total_rain),
z_max_rain   = scale(max_rain),
z_rain_days  = scale(rain_days)
)

m_rain_only <- glm.nb(
active_nests ~ z_total_rain + z_max_rain + z_rain_days,
data = effort_weather
)
summary(m_rain_only)

```

### Temp 

```{r}
effort_weather <- effort_weather |>
mutate(
z_mean_temp = scale(mean_temp),
z_max_temp  = scale(max_temp),
z_min_temp  = scale(min_temp)
)

max_temp_mod <- glm.nb(
active_nests ~ z_max_temp,
data = effort_weather
)
summary(max_temp_mod)

min_temp_mod <- glm.nb(
active_nests ~ z_min_temp,
data = effort_weather
)
summary(min_temp_mod)

mean_temp_mod <- glm.nb(
active_nests ~ z_mean_temp,
data = effort_weather
)
summary(mean_temp_mod)

```


### Wind 

```{r}
effort_weather <- effort_weather |>
mutate(
z_mean_wind = scale(mean_wind),
z_max_wind  = scale(max_wind)
)

m_wind_only <- glm.nb(
active_nests ~ z_mean_wind + z_max_wind,
data = effort_weather
)
summary(m_wind_only)

```

### Hail 

```{r}
effort_weather <- effort_weather |>
mutate(z_hail_days = scale(hail_days))

m_hail_only <- glm.nb(
active_nests ~ z_hail_days,
data = effort_weather
)
summary(m_hail_only)

```



### Active nests across years 

```{r}
active.nests <- vultures.clean |>
mutate(year = year(ringing.date)) |>
group_by(year) |>
summarise(active_nests = n(), .groups = "drop")

m_year <- glm.nb(active_nests ~ year, data = active.nests)

active.nests_plot <- active.nests |>
mutate(pred_year = predict(m_year, newdata = active.nests, type = "response"))

ggplot(active.nests_plot, aes(x = year, y = active_nests)) +
geom_col(fill = "#89c5d6", alpha = 0.85) +
geom_line(aes(y = pred_year), linewidth = 1.1, colour = "black") +
labs(
x = "Year",
y = "Number of active nests"
) +
theme_bw() +
theme(panel.grid = element_blank())

```

### Effects of max temp on effort

```{r}
effort_weather <- active.nests |>
left_join(weather_yearly, by = c("year" = "YEAR")) |>
mutate(
z_total_rain = as.numeric(scale(total_rain)),
z_max_rain   = as.numeric(scale(max_rain)),
z_rain_days  = as.numeric(scale(rain_days)),
z_mean_temp  = as.numeric(scale(mean_temp)),
z_max_temp   = as.numeric(scale(max_temp)),
z_min_temp   = as.numeric(scale(min_temp)),
z_mean_wind  = as.numeric(scale(mean_wind)),
z_max_wind   = as.numeric(scale(max_wind)),
z_hail_days  = as.numeric(scale(hail_days))
)

m_eff_maxtemp <- glm.nb(
active_nests ~ z_max_temp,
data = effort_weather
)
summary(m_eff_maxtemp)

new_eff_temp <- tibble(
z_max_temp = seq(
min(effort_weather$z_max_temp, na.rm = TRUE),
max(effort_weather$z_max_temp, na.rm = TRUE),
length.out = 100
)
) |>
mutate(
pred_nests = predict(
m_eff_maxtemp,
newdata = cur_data(),
type = "response"
)
)

ggplot(effort_weather, aes(x = z_max_temp, y = active_nests)) +
geom_point(alpha = 0.7) +
geom_line(
data = new_eff_temp,
aes(x = z_max_temp, y = pred_nests),
linewidth = 1.1
) +
labs(
x = "Annual maximum temperature (scaled)",
y = "Number of active nests"
) +
theme_bw() +
theme(panel.grid = element_blank())

```



```{r}
acf(active.nests$active_nests)

```

## Objective 2
### Success DF 

```{r}
failed.nests <- vultures.clean |>
mutate(year = year(ringing.date)) |>
filter(!is.na(year)) |>
group_by(year) |>
summarise(
active_nests  = n(),
success_nests = sum(!is.na(laying.date)),
failed_nests  = active_nests - success_nests,
success_prop  = success_nests / active_nests,
.groups       = "drop"
) |>
filter(active_nests > 0)

```

### Year only model 

```{r}
success_year <- glm(
cbind(success_nests, failed_nests) ~ year,
family = binomial,
data   = failed.nests
)
summary(success_year)
check_overdispersion(success_year)

```

### Rain 

```{r}
success_df <- failed.nests |>
left_join(weather_yearly, by = c("year" = "YEAR")) |>
mutate(
z_total_rain = as.numeric(scale(total_rain)),
z_max_rain   = as.numeric(scale(max_rain)),
z_rain_days  = as.numeric(scale(rain_days))
)

success_rain <- glm(
cbind(success_nests, failed_nests) ~
z_total_rain + z_max_rain + z_rain_days,
family = binomial,
data   = success_df
)
summary(success_rain)
check_overdispersion(success_rain)

```

### Temp 

```{r}
success_df <- success_df |>
mutate(
z_mean_temp = as.numeric(scale(mean_temp)),
z_max_temp  = as.numeric(scale(max_temp)),
z_min_temp  = as.numeric(scale(min_temp))
)

success_minT <- glm(
cbind(success_nests, failed_nests) ~ z_min_temp,
family = binomial,
data   = success_df
)
summary(success_minT)
check_overdispersion(success_minT)

success_maxT <- glm(
cbind(success_nests, failed_nests) ~ z_max_temp,
family = binomial,
data   = success_df
)
summary(success_maxT)
check_overdispersion(success_maxT)

success_meanT <- glm(
cbind(success_nests, failed_nests) ~ z_mean_temp,
family = binomial,
data   = success_df
)
summary(success_meanT)
check_overdispersion(success_meanT)

```

### WInd 

```{r}
success_df <- success_df |>
mutate(
z_mean_wind = as.numeric(scale(mean_wind)),
z_max_wind  = as.numeric(scale(max_wind))
)

m_success_wind <- glm(
cbind(success_nests, failed_nests) ~ z_mean_wind + z_max_wind,
family = binomial,
data   = success_df
)
summary(m_success_wind)
check_overdispersion(m_success_wind)

```

### Hail 

```{r}
success_df <- success_df |>
mutate(
z_hail_days = as.numeric(scale(hail_days))
)

m_success_hail <- glm(
cbind(success_nests, failed_nests) ~ z_hail_days,
family = binomial,
data   = success_df
)
summary(m_success_hail)
check_overdispersion(m_success_hail)

```

## Objective 3

### 60 and 30 day pre laying period 

```{r}
timing_df <- vultures.clean |>
filter(!is.na(laying.date)) |>
mutate(
year    = year(laying.date),
lay_DOY = yday(laying.date)
)

summarise_60 <- function(lay_date, weather) {
w <- weather |>
filter(date > (lay_date - days(60)), date <= lay_date)

tibble(
mean_temp_60  = mean(w$mean_temp, na.rm = TRUE),
max_temp_60   = mean(w$max_temp, na.rm = TRUE),
min_temp_60   = mean(w$min_temp, na.rm = TRUE),
total_rain_60 = sum(w$rain, na.rm = TRUE),
rain_days_60  = sum(w$rain_day, na.rm = TRUE),
mean_wind_60  = mean(w$mean_wind, na.rm = TRUE),
max_wind_60   = mean(w$max_wind, na.rm = TRUE),
hail_days_60  = sum(w$hail, na.rm = TRUE)
)
}

timing_weather_60 <- timing_df |>
mutate(win60 = purrr::map(laying.date, summarise_60, weather = weather_lag)) |>
unnest(win60)

summarise_30 <- function(lay_date, weather) {
  w <- weather |>
    filter(date > (lay_date - days(30)), date <= lay_date)

  tibble(
    mean_temp_30  = mean(w$mean_temp, na.rm = TRUE),
    max_temp_30   = mean(w$max_temp,  na.rm = TRUE),
    min_temp_30   = mean(w$min_temp,  na.rm = TRUE),
    total_rain_30 = sum(w$rain,       na.rm = TRUE),
    rain_days_30  = sum(w$rain_day,   na.rm = TRUE),
    mean_wind_30  = mean(w$mean_wind, na.rm = TRUE),
    max_wind_30   = mean(w$max_wind,  na.rm = TRUE),
    hail_days_30  = sum(w$hail,       na.rm = TRUE)
  )
}

timing_weather_30 <- timing_df |>
  mutate(win30 = purrr::map(laying.date, summarise_30, weather = weather_lag)) |>
  tidyr::unnest(win30)

```

### Temp 

```{r}
m_timing_temp_60 <- lm(
lay_DOY ~ mean_temp_60 + max_temp_60 + min_temp_60,
data = timing_weather_60
)
summary(m_timing_temp_60)

```


### Rain 

```{r}
m_timing_rain_60 <- lm(
lay_DOY ~ total_rain_60 + rain_days_60,
data = timing_weather_60
)
summary(m_timing_rain_60)

```

### Hail 

```{r}
m_timing_rain_60 <- lm(
lay_DOY ~ total_rain_60 + rain_days_60,
data = timing_weather_60
)
summary(m_timing_rain_60)

```

### Test 

```{r}
plot(failed.nests$year, failed.nests$success_prop)

```









--------------------------------------------------------------------------------

## Candidate model set

### Objective 1

```{r}

objective1_table <- tribble(
  ~`Hypothesis / justification`, ~Model,

  # ---- Temperature ----
  "**Temp**", NA,
  "Warmer years increase energetic cost of adult birds, reducing likelihood to breed.",
  "active_nests ~ mean_temp",

  "Extreme heat events cause thermal stress, reducing breeding effort (active cooling is energetically costly and may reduce adult condition).",
  "active_nests ~ max_temp",

  "Cold extremes increase thermoregulatory demand (often increasing time spent foraging), reducing effort put into breeding",
  "active_nests ~ min_temp",

  # ---- Rain ----
  "**Rain**", NA,
  "High rainfall reduces foraging efficiency and adult condition, reducing breeding effort.",
  "active_nests ~ total_rain",

  "Prolonged rainfall conditions reduce breeding effort by limiting foraging opportunity (fewer or weaker thermals for soaring)",
  "active_nests ~ rain_days",

  "Intense rainfall events decrease foraging efficiency and nest attendance, reducing breeding effort.",
  "active_nests ~ max_rain",

  "Previous year’s rainfall influences food availability and adult condition, affecting breeding effort in the following year.",
  "active_nests ~ lag_total_rain",

  # ---- Wind ----
  "**Wind**", NA,
  "Persistent windy conditions increase the cost of flying, limiting foraging and the energy available for reproduction, reducing breeding effort",
  "active_nests ~ mean_wind",

  "Extreme winds increase nest damage risk, reducing the likelihood that adults will attempt breeding (WBV often reuse nests from previous years) ",
  "active_nests ~ max_wind",

  # ---- Hail ----
  "**Hail**", NA,
  "Severe storm events increase disturbance and nest damage risk, reducing breeding effort",
  "active_nests ~ hail_days",

  # ---- Joint Effects ----
  "**Joint effects**", NA,
  "Cold stress combined with prolonged wet conditions jointly limit breeding effort",
  "active_nests ~ min_temp + total_rain",

  "Cold stress combined with intense rainfall events reduces breeding effort",
  "active_nests ~ min_temp + max_rain",

  "Cold extremes combined with extreme wind increase energetic costs and breeding risk, reducing breeding effort",
  "active_nests ~ min_temp + max_wind",

  "Severe storm exposure combined with extreme wind increases nest disturbance, reducing breeding effort",
  "active_nests ~ hail_days + max_wind",

  "Reduced thermals for soaring combined with high flight costs limit breeding effort",
  "active_nests ~ max_rain + max_wind",
  
  "Heat stress combined with prolonged wet conditions jointly reduce breeding effort by increasing energetic costs while limiting foraging",
  "active_nests ~ max_temp + rain_days",
  
 " High annual rainfall and frequent hail events each impose energetic and disturbance costs that reduce breeding effort.",
"active_nests ~ hail_days + rain_days",

  # ---- Interactive Effects ----
  "**Interactive effects**", NA,
  "The negative effect of cold extremes on breeding effort is increased in persistently wet years.",
  "active_nests ~ min_temp * rain_days",

  "Cold-related energetic stress is amplified in windy years due to increased heat loss and flight costs",
  "active_nests ~ min_temp * mean_wind",

  "Adult condition resulting from the previous year interacts with current-year heat stress to influence breeding effort",
  "active_nests ~ lag_total_rain * max_temp"
)

objective1_table_clean <- objective1_table |>
  dplyr::mutate(Model = ifelse(is.na(Model), "", Model))

kable(
  objective1_table_clean,
  align = c("l", "l"),
  caption = "Objective 1 candidate model set for breeding effort (active nests)"
)




```

```{r}
# Annual effort: number of active nests per year
active.nests <- vultures.clean |>
  mutate(year = year(ringing.date)) |>
  group_by(year) |>
  summarise(active_nests = n(), .groups = "drop")


# Join to weather, create log effort response
effort_weather <- active.nests |>
  left_join(weather_yearly_lag, by = c("year" = "YEAR")) |>
  filter(!is.na(lag_total_rain)) |>
  mutate(
    log_active_nests = log(active_nests)
  )

```


```{r}
# checking residuals
par(mfrow = c(1, 2))
```


### Fitingt then no-year models

```{r}
# Baseline 
m_null <- lm(log_active_nests ~ 1, data = effort_weather)

# Single predictor models 
m_mean_temp      <- lm(log_active_nests ~ mean_temp,      data = effort_weather)
m_max_temp       <- lm(log_active_nests ~ max_temp,       data = effort_weather)
m_min_temp       <- lm(log_active_nests ~ min_temp,       data = effort_weather)

m_total_rain     <- lm(log_active_nests ~ total_rain,     data = effort_weather)
m_rain_days      <- lm(log_active_nests ~ rain_days,      data = effort_weather)
m_max_rain       <- lm(log_active_nests ~ max_rain,       data = effort_weather)
m_lag_total_rain <- lm(log_active_nests ~ lag_total_rain, data = effort_weather)

m_mean_wind      <- lm(log_active_nests ~ mean_wind,      data = effort_weather)
m_max_wind       <- lm(log_active_nests ~ max_wind,       data = effort_weather)
m_hail_days      <- lm(log_active_nests ~ hail_days,      data = effort_weather)

# Joint effects 
m_minT_totalR    <- lm(log_active_nests ~ min_temp + total_rain,  data = effort_weather)
m_minT_maxR      <- lm(log_active_nests ~ min_temp + max_rain,    data = effort_weather)
m_minT_maxW      <- lm(log_active_nests ~ min_temp + max_wind,    data = effort_weather)
m_hail_maxW      <- lm(log_active_nests ~ hail_days + max_wind,   data = effort_weather)
m_maxR_maxW      <- lm(log_active_nests ~ max_rain + max_wind,    data = effort_weather)
m_maxT_rainDays  <- lm(log_active_nests ~ max_temp + rain_days,   data = effort_weather)
m_hail_rainDays  <- lm(log_active_nests ~ hail_days + rain_days,  data = effort_weather)

# Interactions 
m_minT_x_rainDays <- lm(log_active_nests ~ min_temp * rain_days,      data = effort_weather)
m_minT_x_meanWind <- lm(log_active_nests ~ min_temp * mean_wind,      data = effort_weather)
m_lagR_x_maxT     <- lm(log_active_nests ~ lag_total_rain * max_temp, data = effort_weather)
```

### Fit with year models 

```{r}
# Baseline 
m_year <- lm(log_active_nests ~ year, data = effort_weather)

# Single predictor models 
m_mean_temp_year      <- lm(log_active_nests ~ year + mean_temp,      data = effort_weather)
m_max_temp_year       <- lm(log_active_nests ~ year + max_temp,       data = effort_weather)
m_min_temp_year       <- lm(log_active_nests ~ year + min_temp,       data = effort_weather)

m_total_rain_year     <- lm(log_active_nests ~ year + total_rain,     data = effort_weather)
m_rain_days_year      <- lm(log_active_nests ~ year + rain_days,      data = effort_weather)
m_max_rain_year       <- lm(log_active_nests ~ year + max_rain,       data = effort_weather)
m_lag_total_rain_year <- lm(log_active_nests ~ year + lag_total_rain, data = effort_weather)

m_mean_wind_year      <- lm(log_active_nests ~ year + mean_wind,      data = effort_weather)
m_max_wind_year       <- lm(log_active_nests ~ year + max_wind,       data = effort_weather)
m_hail_days_year      <- lm(log_active_nests ~ year + hail_days,      data = effort_weather)

# Joint effects 
m_minT_totalR_year    <- lm(log_active_nests ~ year + min_temp + total_rain, data = effort_weather)
m_minT_maxR_year      <- lm(log_active_nests ~ year + min_temp + max_rain,   data = effort_weather)
m_minT_maxW_year      <- lm(log_active_nests ~ year + min_temp + max_wind,   data = effort_weather)
m_hail_maxW_year      <- lm(log_active_nests ~ year + hail_days + max_wind,  data = effort_weather)
m_maxR_maxW_year      <- lm(log_active_nests ~ year + max_rain + max_wind,   data = effort_weather)
m_maxT_rainDays_year  <- lm(log_active_nests ~ year + max_temp + rain_days,  data = effort_weather)
m_hail_rainDays_year  <- lm(log_active_nests ~ year + hail_days + rain_days, data = effort_weather)

# Interactions 
m_minT_x_rainDays_year <- lm(log_active_nests ~ year + min_temp * rain_days,      data = effort_weather)
m_minT_x_meanWind_year <- lm(log_active_nests ~ year + min_temp * mean_wind,      data = effort_weather)
m_lagR_x_maxT_year     <- lm(log_active_nests ~ year + lag_total_rain * max_temp, data = effort_weather)
```



---

Two separate AICc model selection runs

```{r}
# AIC 1: without year
cand_effort_no_year <- list(
  null            = m_null,

  mean_temp       = m_mean_temp,
  max_temp        = m_max_temp,
  min_temp        = m_min_temp,
  total_rain      = m_total_rain,
  rain_days       = m_rain_days,
  max_rain        = m_max_rain,
  lag_total_rain  = m_lag_total_rain,
  mean_wind       = m_mean_wind,
  max_wind        = m_max_wind,
  hail_days       = m_hail_days,

  minT_totalR     = m_minT_totalR,
  minT_maxR       = m_minT_maxR,
  minT_maxW       = m_minT_maxW,
  hail_maxW       = m_hail_maxW,
  maxR_maxW       = m_maxR_maxW,
  maxT_rainDays   = m_maxT_rainDays,
  hail_rainDays   = m_hail_rainDays,

  minT_x_rainDays = m_minT_x_rainDays,
  minT_x_meanWind = m_minT_x_meanWind,
  lagR_x_maxT     = m_lagR_x_maxT
)

aic_effort_no_year <- aictab(cand.set = cand_effort_no_year, modnames = names(cand_effort_no_year))
aic_effort_no_year
```

```{r}
# AIC 2: with year
cand_effort_with_year <- list(
  year               = m_year,

  mean_temp          = m_mean_temp_year,
  max_temp           = m_max_temp_year,
  min_temp           = m_min_temp_year,
  total_rain         = m_total_rain_year,
  rain_days          = m_rain_days_year,
  max_rain           = m_max_rain_year,
  lag_total_rain     = m_lag_total_rain_year,
  mean_wind          = m_mean_wind_year,
  max_wind           = m_max_wind_year,
  hail_days          = m_hail_days_year,

  minT_totalR        = m_minT_totalR_year,
  minT_maxR          = m_minT_maxR_year,
  minT_maxW          = m_minT_maxW_year,
  hail_maxW          = m_hail_maxW_year,
  maxR_maxW          = m_maxR_maxW_year,
  maxT_rainDays      = m_maxT_rainDays_year,
  hail_rainDays      = m_hail_rainDays_year,

  minT_x_rainDays    = m_minT_x_rainDays_year,
  minT_x_meanWind    = m_minT_x_meanWind_year,
  lagR_x_maxT        = m_lagR_x_maxT_year
)

aic_effort_with_year <- aictab(cand.set = cand_effort_with_year, modnames = names(cand_effort_with_year))
aic_effort_with_year

```

### Check residuals

```{r}
# Diagnostics for top model withoyt year
best_no_year_E <- cand_effort_no_year[[ which.min(aic_effort_no_year$AICc) ]]
par(mfrow = c(2,2)); plot(best_no_year_E)

# Diagnostics for top model with year
best_with_year_E <- cand_effort_with_year[[ which.min(aic_effort_with_year$AICc) ]]
par(mfrow = c(2,2)); plot(best_with_year_E)
```

```{r}
# year-only baseline and best with-year model
summary(m_year)$adj.r.squared
summary(best_with_year_E)$adj.r.squared

# best no-year model
summary(best_no_year_E)$adj.r.squared
```

### Figures 

```{r}

ggplot(effort_weather, aes(x = year, y = active_nests)) +
  geom_point(size = 2, colour = "grey30") +
  geom_smooth(method = "lm", se = TRUE, colour = "black") +
  scale_x_continuous(breaks = seq(min(effort_weather$year), max(effort_weather$year), by = 5)) +
  labs(
    x = "Year",
    y = "Number of active nests",
    title = "Annual breeding effort at Dronfield Nature Reserve"
  ) +
  theme_bw() +
  theme(panel.grid = element_blank())

```




```{r}

prep_aic_plot <- function(aic_obj, set_label){
  df <- as.data.frame(aic_obj)

  # model names
  if ("Modnames" %in% names(df)) df$model <- df$Modnames
  if (!"model" %in% names(df)) df$model <- rownames(df)

  df |>
    dplyr::mutate(set = set_label) |>
    dplyr::rename(delta = Delta_AICc, weight = AICcWt) |>
    dplyr::select(set, model, delta, weight)
}

aic_plot_df <- dplyr::bind_rows(
  prep_aic_plot(aic_effort_with_year, "With year"),
  prep_aic_plot(aic_effort_no_year, "Without year")
) |>
  dplyr::filter(delta <= 3) |>
  dplyr::group_by(set) |>
  dplyr::mutate(model = forcats::fct_reorder(model, -delta)) |>
  dplyr::ungroup()

ggplot(aic_plot_df, aes(x = delta, y = model)) +
  geom_vline(xintercept = 2, linetype = 2) +
  geom_point(aes(size = weight), colour = "grey20") +
  facet_wrap(~set, scales = "free_y") +
  scale_size_continuous(range = c(2, 8)) +
  labs(
    x = expression(Delta*"AICc (lower is better)"),
    y = NULL,
    title = "Support for candidate models with and without year",
    subtitle = "Only models with ΔAICc ≤ 3 are shown; point size indicates AICc weight"
  ) +
  theme_bw() +
  theme(panel.grid = element_blank())

```


```{r}
effort_weather <- effort_weather |>
  mutate(
    fit_year = fitted(m_year),
    fit_best = fitted(best_with_year_E)
  )

library(tidyr)

plot_fit_df <- effort_weather |>
  dplyr::select(year, log_active_nests, fit_year, fit_best) |>
  pivot_longer(cols = c(fit_year, fit_best),
               names_to = "model",
               values_to = "fitted") |>
  mutate(model = recode(model,
                        fit_year = "Year-only model",
                        fit_best = "Year + weather model"))

library(ggplot2)

ggplot(plot_fit_df, aes(x = year)) +
  geom_point(aes(y = log_active_nests), colour = "grey35", size = 2) +
  geom_line(aes(y = fitted, linetype = model), linewidth = 1) +
  scale_x_continuous(breaks = seq(min(plot_fit_df$year),
                                  max(plot_fit_df$year),
                                  by = 5)) +
  labs(
    x = "Year",
    y = "log(Number of active nests)",
    title = "Observed and fitted breeding effort",
    subtitle = "Comparison of year-only and year + weather models"
  ) +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

```


```{r}

# build Table 1(weather-only) 
aic_df <- as.data.frame(aic_effort_no_year)

# model ids
if ("Modnames" %in% names(aic_df)) {
  aic_df <- aic_df |> dplyr::mutate(model_id = Modnames)
} else {
  aic_df <- tibble::rownames_to_column(aic_df, "model_id")
}

table1 <- aic_df |>
  dplyr::rename(
    K = K,
    AICc = AICc,
    `ΔAICc` = Delta_AICc,
    w = AICcWt
  ) |>
  dplyr::select(model_id, K, AICc, `ΔAICc`, w) |>
  dplyr::arrange(`ΔAICc`) |>
  dplyr::filter(`ΔAICc` <= 4)  

# add Adj R2 + slope(SE)
get_stats <- function(mod){
  adjr2 <- summary(mod)$adj.r.squared
  if (length(coef(mod)) == 2) {
    cf <- summary(mod)$coefficients
    slope_se <- paste0(round(cf[2,1], 3), " (", round(cf[2,2], 3), ")")
  } else {
    slope_se <- ""
  }
  tibble::tibble(`Adj. R²` = adjr2, `slope (SE)` = slope_se)
}

stats_df <- lapply(table1$model_id, function(mn) get_stats(cand_effort_no_year[[mn]])) |>
  dplyr::bind_rows() |>
  dplyr::mutate(model_id = table1$model_id)

table1 <- table1 |>
  dplyr::left_join(stats_df, by = "model_id") |>
  dplyr::mutate(
    AICc = round(AICc, 2),
    `ΔAICc` = round(`ΔAICc`, 2),
    w = round(w, 3),
    `Adj. R²` = round(`Adj. R²`, 3)
  )

# grouping adn neat names 
group_order <- c("Baseline","Rain","Temperature","Wind","Hail","Joint effects","Interactions")

model_group <- function(m){
  dplyr::case_when(
    m == "null" ~ "Baseline",
    m %in% c("total_rain","rain_days","max_rain","lag_total_rain") ~ "Rain",
    m %in% c("mean_temp","max_temp","min_temp") ~ "Temperature",
    m %in% c("mean_wind","max_wind") ~ "Wind",
    m %in% c("hail_days") ~ "Hail",
    m %in% c("minT_totalR","minT_maxR","minT_maxW","hail_maxW","maxR_maxW","maxT_rainDays","hail_rainDays") ~ "Joint effects",
    m %in% c("minT_x_rainDays","minT_x_meanWind","lagR_x_maxT") ~ "Interactions",
    TRUE ~ "Joint effects"
  )
}

pretty_model <- function(x){
  dplyr::recode(
    x,
    "null"           = "Intercept only",
    "total_rain"     = "Total rainfall",
    "rain_days"      = "Rainy days",
    "max_rain"       = "Maximum daily rainfall",
    "lag_total_rain" = "Previous year's total rainfall",
    "mean_temp"      = "Mean temperature",
    "max_temp"       = "Maximum temperature",
    "min_temp"       = "Minimum temperature",
    "mean_wind"      = "Mean wind speed",
    "max_wind"       = "Maximum wind speed",
    "hail_days"      = "Hail days",
    "minT_totalR"     = "Min temperature + total rainfall",
    "minT_maxR"       = "Min temperature + max daily rainfall",
    "minT_maxW"       = "Min temperature + max wind speed",
    "hail_maxW"       = "Hail days + max wind speed",
    "maxR_maxW"       = "Max daily rainfall + max wind speed",
    "maxT_rainDays"   = "Max temperature + rainy days",
    "hail_rainDays"   = "Hail days + rainy days",
    "minT_x_rainDays" = "Min temperature × rainy days",
    "minT_x_meanWind" = "Min temperature × mean wind speed",
    "lagR_x_maxT"     = "Prev. rainfall × max temperature",
    .default = x
  )
}

table1_clean <- table1 |>
  dplyr::mutate(
    Group = model_group(model_id),
    Model = pretty_model(model_id),
    Group = factor(Group, levels = group_order)
  ) |>
  dplyr::arrange(Group, `ΔAICc`) |>
  dplyr::select(Group, Model, K, AICc, `ΔAICc`, w, `Adj. R²`, `slope (SE)`)

#print 
group_sizes <- table1_clean |>
  dplyr::count(Group, name = "n") |>
  dplyr::mutate(
    start = cumsum(dplyr::lag(n, default = 0)) + 1,
    end   = cumsum(n)
  )

tbl <- knitr::kable(
  table1_clean |> dplyr::select(-Group),
  caption = "Table 1. Competitive weather-only candidate models (ΔAICc ≤ 4) explaining annual breeding effort (log number of active nests) at Dronfield. K = number of parameters; AICc = small-sample AIC; ΔAICc = difference from the best model; w = Akaike weight. Adjusted R² is shown for all models; slope (SE) is reported only for single-predictor models.",
  align = "l"
) |>
  kableExtra::kable_styling(full_width = FALSE)

for(i in seq_len(nrow(group_sizes))){
  tbl <- tbl |>
    kableExtra::pack_rows(as.character(group_sizes$Group[i]),
                          group_sizes$start[i],
                          group_sizes$end[i])
}

tbl


```

```{r}

delta_cutoff <- 4      # competitive set
digits_aic   <- 2
digits_r2    <- 3
digits_slope <- 3

# Preferred group order
group_order <- c("Baseline", "Rain", "Temperature", "Wind", "Hail", "Joint effects", "Interactions")

model_group_with_year <- function(m){
  dplyr::case_when(
    m %in% c("year") ~ "Baseline", 

    m %in% c("total_rain","rain_days","max_rain","lag_total_rain") ~ "Rain",
    m %in% c("mean_temp","max_temp","min_temp") ~ "Temperature",
    m %in% c("mean_wind","max_wind") ~ "Wind",
    m %in% c("hail_days") ~ "Hail",

    m %in% c("minT_totalR","minT_maxR","minT_maxW","hail_maxW","maxR_maxW","maxT_rainDays","hail_rainDays") ~ "Joint effects",
    m %in% c("minT_x_rainDays","minT_x_meanWind","lagR_x_maxT") ~ "Interactions",

    TRUE ~ "Joint effects"
  )
}

pretty_model_with_year <- function(x){
  dplyr::recode(
    x,
    "year"           = "Year (baseline)",

    "total_rain"     = "Total rainfall",
    "rain_days"      = "Rainy days",
    "max_rain"       = "Maximum daily rainfall",
    "lag_total_rain" = "Previous year's total rainfall",

    "mean_temp"      = "Mean temperature",
    "max_temp"       = "Maximum temperature",
    "min_temp"       = "Minimum temperature",

    "mean_wind"      = "Mean wind speed",
    "max_wind"       = "Maximum wind speed",

    "hail_days"      = "Hail days",

    "minT_totalR"    = "Min temperature + total rainfall",
    "minT_maxR"      = "Min temperature + max daily rainfall",
    "minT_maxW"      = "Min temperature + max wind speed",
    "hail_maxW"      = "Hail days + max wind speed",
    "maxR_maxW"      = "Max daily rainfall + max wind speed",
    "maxT_rainDays"  = "Max temperature + rainy days",
    "hail_rainDays"  = "Hail days + rainy days",

    "minT_x_rainDays" = "Min temperature × rainy days",
    "minT_x_meanWind" = "Min temperature × mean wind speed",
    "lagR_x_maxT"     = "Prev. rainfall × max temperature",

    .default = x
  )
}

aic_df2 <- as.data.frame(aic_effort_with_year)


if ("Modnames" %in% names(aic_df2)) {
  aic_df2 <- dplyr::mutate(aic_df2, model = Modnames)
} else {
  aic_df2 <- tibble::rownames_to_column(aic_df2, "model")
}

aic_df2 <- aic_df2 %>%
  dplyr::rename(
    K     = K,
    AICc  = AICc,
    dAICc = Delta_AICc,
    w     = AICcWt
  ) %>%
  dplyr::select(model, K, AICc, dAICc, w) %>%
  dplyr::arrange(dAICc) %>%
  dplyr::filter(dAICc <= delta_cutoff) %>%
  dplyr::filter(model != "year")  

#
get_stats_with_year <- function(mod){
  adjr2 <- summary(mod)$adj.r.squared

  if (length(coef(mod)) == 3) {
    cf <- summary(mod)$coefficients
   
    slope <- unname(cf[3, 1])
    se    <- unname(cf[3, 2])
    slope_se <- paste0(round(slope, digits_slope), " (", round(se, digits_slope), ")")
  } else {
    slope_se <- ""
  }

  tibble(adj_R2 = adjr2, slope_SE = slope_se)
}

stats_df2 <- lapply(aic_df2$model, function(mn) get_stats_with_year(cand_effort_with_year[[mn]])) %>%
  dplyr::bind_rows() %>%
  dplyr::mutate(model = aic_df2$model)

table2 <- aic_df2 %>%
  dplyr::left_join(stats_df2, by = "model") %>%
  dplyr::mutate(
    AICc   = round(AICc, digits_aic),
    dAICc  = round(dAICc, digits_aic),
    w      = round(w, 3),
    adj_R2 = round(adj_R2, digits_r2)
  ) %>%
  dplyr::mutate(
    model_id = model,
    Group = model_group_with_year(model_id),
    Model = pretty_model_with_year(model_id),
    Group = factor(Group, levels = group_order)
  ) %>%
  dplyr::arrange(Group, dAICc) %>%
  dplyr::rename(
    `ΔAICc` = dAICc,
    `Adj. R²` = adj_R2,
    `slope (SE)` = slope_SE
  ) %>%
  dplyr::select(Group, Model, K, AICc, `ΔAICc`, w, `Adj. R²`, `slope (SE)`)


group_sizes2 <- table2 %>%
  dplyr::count(Group, name = "n") %>%
  dplyr::mutate(
    start = cumsum(dplyr::lag(n, default = 0)) + 1,
    end   = cumsum(n)
  )

tbl2 <- knitr::kable(
  table2 %>% dplyr::select(-Group),
  caption = "Table 2. Competitive candidate models including year (ΔAICc ≤ 4) explaining annual breeding effort (log number of active nests) at Dronfield. K = number of parameters; AICc = small-sample AIC; ΔAICc = difference from the best model; w = Akaike weight. Adjusted R² is shown for all models; slope (SE) is reported only for models with a single weather predictor in addition to year.",
  align = "l"
) %>%
  kableExtra::kable_styling(full_width = FALSE)

for(i in seq_len(nrow(group_sizes2))){
  tbl2 <- tbl2 %>%
    kableExtra::pack_rows(as.character(group_sizes2$Group[i]),
                          group_sizes2$start[i],
                          group_sizes2$end[i])
}

tbl2


```



--------------------------------------------------------------------------------


### Objective 2: Breeding success

```{r}
objective2_table <- tribble(
  ~`Hypothesis / justification`, ~Model,

  # ---- Temperature ----
  "**Temp**", "",
  "Extreme heat events cause chick heat stress and dehydration, reducing fledging success",
  "success ~ max_temp + (1 | year)",

  "Cold extremes increase thermoregulatory demand in chicks, increasing mortality risk",
  "success ~ min_temp + (1 | year)",

  # ---- Rain ----
  "**Rain**", "",
  "Prolonged rainfall reduces adult foraging efficiency, limiting food delivery to chicks and reducing breeding success",
  "success ~ rain_days + (1 | year)",

  "Intense rainfall events cause acute nest disturbance and chick exposure, reducing breeding success",
  "success ~ max_rain + (1 | year)",

  "Overall wet years reduce provisioning efficiency across the breeding season, lowering breeding success",
  "success ~ total_rain + (1 | year)",

  # ---- Wind ----
  "**Wind**", "",
  "Extreme winds increase nest exposure and disrupt provisioning, reducing chick survival",
  "success ~ max_wind + (1 | year)",

  # ---- Hail ----
  "**Hail**", "",
  "Severe hail events increase nest destruction and chick mortality, reducing breeding success",
  "success ~ hail_days + (1 | year)",

  # ---- Joint Effects ----
  "**Joint effects**", "",
  "Severe storm exposure increases nest destruction and chick mortality, reducing breeding success",
  "success ~ hail_days + max_wind + (1 | year)",

  "Prolonged wet conditions combined with storm events increase chick exposure and limit provisioning, reducing breeding success",
  "success ~ rain_days + hail_days + (1 | year)",

  "Heat stress combined with prolonged wet conditions reduces chick thermoregulation and food delivery, lowering breeding success",
  "success ~ max_temp + rain_days + (1 | year)",

  # ---- Interactive Effects ----
  "**Interactive effects**", "",
  "The negative effect of heat stress on breeding success is amplified during persistently wet conditions that limit adult foraging",
  "success ~ max_temp * rain_days + (1 | year)",

  "Cold stress on chicks is amplified during extreme wind events due to increased exposure and heat loss, reducing breeding success",
  "success ~ min_temp * max_wind + (1 | year)"
)

kable(
  objective2_table,
  align = c("l", "l"),
  caption = "Objective 2 candidate model set for breeding success. All models are fitted as binomial GLMMs: cbind(success_nests, failed_nests) with a random intercept for year (1 | year)"
)
```

success ~ 1 + (1 | year)

```{r}
library(lme4)

success_df <- success_df |> mutate(year = factor(year))

m0 <- glmer(
  cbind(success_nests, failed_nests) ~ 1 + (1 | year),
  family = binomial,
  data = success_df
)
summary(m0)

```

```{r}
library(lme4)

success_df <- success_df |> dplyr::mutate(year = factor(year))

# Baseline (null) model

m0_success <- glmer(
  cbind(success_nests, failed_nests) ~ 1 + (1 | year),
  family = binomial,
  data = success_df
)

# Single predictor models

m_succ_maxT <- glmer(
  cbind(success_nests, failed_nests) ~ z_max_temp + (1 | year),
  family = binomial, data = success_df
)

m_succ_minT <- glmer(
  cbind(success_nests, failed_nests) ~ z_min_temp + (1 | year),
  family = binomial, data = success_df
)

m_succ_rainD <- glmer(
  cbind(success_nests, failed_nests) ~ z_rain_days + (1 | year),
  family = binomial, data = success_df
)

m_succ_maxR <- glmer(
  cbind(success_nests, failed_nests) ~ z_max_rain + (1 | year),
  family = binomial, data = success_df
)

m_succ_totR <- glmer(
  cbind(success_nests, failed_nests) ~ z_total_rain + (1 | year),
  family = binomial, data = success_df
)

m_succ_maxW <- glmer(
  cbind(success_nests, failed_nests) ~ z_max_wind + (1 | year),
  family = binomial, data = success_df
)

m_succ_hail <- glmer( 
  cbind(success_nests, failed_nests) ~ z_hail_days + (1 | year),
  family = binomial, data = success_df
)

# Joint effects

m_succ_hailW <- glmer(
  cbind(success_nests, failed_nests) ~ z_hail_days + z_max_wind + (1 | year),
  family = binomial, data = success_df
)

m_succ_rainH <- glmer(
  cbind(success_nests, failed_nests) ~ z_rain_days + z_hail_days + (1 | year),
  family = binomial, data = success_df
)

m_succ_heatR <- glmer(
  cbind(success_nests, failed_nests) ~ z_max_temp + z_rain_days + (1 | year),
  family = binomial, data = success_df
)

# Interactions

m_succ_int_heat_rain <- glmer(
  cbind(success_nests, failed_nests) ~ z_max_temp * z_rain_days + (1 | year),
  family = binomial, data = success_df
)

m_succ_int_cold_wind <- glmer(
  cbind(success_nests, failed_nests) ~ z_min_temp * z_max_wind + (1 | year),
  family = binomial, data = success_df
)

```

```{r}

# Candidate set + AIC

library(AICcmodavg)

cand_success <- list(
  null_re      = m0_success,

  max_temp     = m_succ_maxT,
  min_temp     = m_succ_minT,
  rain_days    = m_succ_rainD,
  max_rain     = m_succ_maxR,
  total_rain   = m_succ_totR,
  max_wind     = m_succ_maxW,
  hail_days    = m_succ_hail,

  hail_maxW    = m_succ_hailW,
  rain_hail    = m_succ_rainH,
  maxT_rainD   = m_succ_heatR,

  int_heatRain = m_succ_int_heat_rain,
  int_coldWind = m_succ_int_cold_wind
)

aic_success <- aictab(
  cand.set  = cand_success,
  modnames  = names(cand_success)
)

aic_success

```

```{r}
v0 <- as.data.frame(VarCorr(m0_success))$vcov[1]
v_minT <- as.data.frame(VarCorr(m_succ_minT))$vcov[1]

(v0 - v_minT) / v0

```




--------------------------------------------------------------------------------

### Objective 3

```{r}
hist(timing_weather_60$lay_DOY)
qqnorm(timing_weather_60$lay_DOY)
qqline(timing_weather_60$lay_DOY)

```


```{r}
objective3_table <- tribble(
  ~`Hypothesis / justification`, ~Model,

  # ---- Temperature (pre-laying cues) ----
  "**Temp (pre-laying)**", "",
  "Short-term warm conditions prior to laying may act as a cue for the initiation of breeding.",
  "lay_DOY ~ mean_temp_60",

  "Cold pre-laying conditions delay breeding due to increased energetic costs",
  "lay_DOY ~ min_temp_60",


  # ---- Rain (pre-laying cues) ----
  "**Rain (pre-laying)**", "",
  "Prolonged wet conditions prior to laying delay breeding by limiting foraging efficiency",
  "lay_DOY ~ rain_days_60",

  "Higher rainfall prior to laying signals improved food availability and advances breeding timing",
  "lay_DOY ~ total_rain_60",

  # ---- Wind (pre-laying flight conditions) ----
  "**Wind (pre-laying)**", "",
  "Persistent windy conditions prior to laying increase flight costs and delay breeding timing",
  "lay_DOY ~ mean_wind_60",

  # ---- Lagged effects (carry-over cues) ----
  "**Lagged effects (previous year)**", "",
  "Higher rainfall in the previous year improves food availability and adult condition entering the breeding season, allowing vultures to initiate breeding earlier",
  "lay_DOY ~ lag_total_rain",

  "Prolonged wet conditions in the previous year may influence adult condition and carry over to affect laying timing",
  "lay_DOY ~ lag_rain_days",

  "Thermal conditions in the previous year influence physiological state entering the breeding season",
  "lay_DOY ~ lag_mean_temp",

  # ---- Joint effects ----
  "**Joint effects**", "",
  "Temperature and rainfall cues prior to laying jointly influence breeding timing",
  "lay_DOY ~ mean_temp_60 + rain_days_60",

  "Carry-over effects from the previous year interact with current pre-laying rainfall cues",
  "lay_DOY ~ lag_total_rain + rain_days_60",

  "Previous-year rainfall and current temperature jointly influence breeding timing",
  "lay_DOY ~ lag_total_rain + mean_temp_60",

  # ---- Interactive effects ----
  "**Interactive effects**", "",
  "The effect of temperature cues on breeding timing depends on pre-laying rainfall conditions",
  "lay_DOY ~ mean_temp_60 * rain_days_60",

  "Carry-over effects from the previous year modify responses to current pre-laying temperature cues",
  "lay_DOY ~ lag_total_rain * mean_temp_60"
)

kable(
  objective3_table,
  align = c("l", "l"),
  caption = "Objective 3 candidate model set for breeding timing (laying date, day of year)."
)

```

```{r}

# 60 days prior
timing_weather_60 <- timing_weather_60 |>
  left_join(
    weather_yearly_lag |>
      dplyr::select(
        YEAR,
        lag_total_rain,
        lag_rain_days,
        lag_mean_temp
      ),
    by = c("year" = "YEAR")
  )

# 30 days prior
timing_weather_30 <- timing_weather_30 |>
  left_join(
    weather_yearly_lag |>
      dplyr::select(
        YEAR,
        lag_total_rain,
        lag_rain_days,
        lag_mean_temp
      ),
    by = c("year" = "YEAR")
  )

```


```{r}

cand_timing_30 <- list(

  meanT_30   = lm(lay_DOY ~ mean_temp_30, data = timing_weather_30),
  maxT_30    = lm(lay_DOY ~ max_temp_30,  data = timing_weather_30),
  minT_30    = lm(lay_DOY ~ min_temp_30,  data = timing_weather_30),

  rainDays_30 = lm(lay_DOY ~ rain_days_30,  data = timing_weather_30),
  totalR_30   = lm(lay_DOY ~ total_rain_30, data = timing_weather_30),

  meanW_30 = lm(lay_DOY ~ mean_wind_30, data = timing_weather_30),
  maxW_30  = lm(lay_DOY ~ max_wind_30,  data = timing_weather_30),

  # lagged (previous year)
  lagTotR  = lm(lay_DOY ~ lag_total_rain, data = timing_weather_30),
  lagRainD = lm(lay_DOY ~ lag_rain_days,  data = timing_weather_30),
  lagMeanT = lm(lay_DOY ~ lag_mean_temp,  data = timing_weather_30),

  # additive
  temp_rain = lm(lay_DOY ~ mean_temp_30 + rain_days_30, data = timing_weather_30),
  temp_wind = lm(lay_DOY ~ mean_temp_30 + mean_wind_30, data = timing_weather_30),
  rain_wind = lm(lay_DOY ~ rain_days_30 + mean_wind_30, data = timing_weather_30),

  # interactions
  temp_x_rain = lm(lay_DOY ~ mean_temp_30 * rain_days_30, data = timing_weather_30),
  minT_x_wind = lm(lay_DOY ~ min_temp_30 * mean_wind_30, data = timing_weather_30),
  lagR_x_temp = lm(lay_DOY ~ lag_total_rain * mean_temp_30, data = timing_weather_30)
)

```


```{r}

aic_timing_30 <- aictab(
  cand.set = cand_timing_30,
  modnames = names(cand_timing_30)
)

```

```{r}

cand_timing_60 <- list(

  meanT_60   = lm(lay_DOY ~ mean_temp_60, data = timing_weather_60),
  maxT_60    = lm(lay_DOY ~ max_temp_60,  data = timing_weather_60),
  minT_60    = lm(lay_DOY ~ min_temp_60,  data = timing_weather_60),

  rainDays_60 = lm(lay_DOY ~ rain_days_60,  data = timing_weather_60),
  totalR_60   = lm(lay_DOY ~ total_rain_60, data = timing_weather_60),

  meanW_60 = lm(lay_DOY ~ mean_wind_60, data = timing_weather_60),
  maxW_60  = lm(lay_DOY ~ max_wind_60,  data = timing_weather_60),

  # lagged (previous year)
  lagTotR  = lm(lay_DOY ~ lag_total_rain, data = timing_weather_60),
  lagRainD = lm(lay_DOY ~ lag_rain_days,  data = timing_weather_60),
  lagMeanT = lm(lay_DOY ~ lag_mean_temp,  data = timing_weather_60),

  # additive
  temp_rain = lm(lay_DOY ~ mean_temp_60 + rain_days_60, data = timing_weather_60),
  temp_wind = lm(lay_DOY ~ mean_temp_60 + mean_wind_60, data = timing_weather_60),
  rain_wind = lm(lay_DOY ~ rain_days_60 + mean_wind_60, data = timing_weather_60),

  # interactions
  temp_x_rain = lm(lay_DOY ~ mean_temp_60 * rain_days_60, data = timing_weather_60),
  minT_x_wind = lm(lay_DOY ~ min_temp_60 * mean_wind_60, data = timing_weather_60),
  lagR_x_temp = lm(lay_DOY ~ lag_total_rain * mean_temp_60, data = timing_weather_60)
)

```

```{r}

aic_timing_60 <- aictab(
  cand.set = cand_timing_60,
  modnames = names(cand_timing_60)
)

```

```{r}
aic_timing_30
summary(cand_timing_30$temp_x_rain)$r.squared


aic_timing_60
summary(cand_timing_60$temp_x_rain)$r.squared

```

```{r}
m_year_trend <- lm(lay_DOY ~ year, data = timing_weather_30)
summary(m_year_trend)

``` 

```{r}
summary(m_year_trend)$r.squared

```

```{r}
m_year_trend60 <- lm(lay_DOY ~ year, data = timing_weather_60)
summary(m_year_trend60)

```



:::




























































































